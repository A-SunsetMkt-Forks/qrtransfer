<!-- <!doctype html> --><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>qrtransfer</title>
    <style>
        svg {
            width: 200 !important;
            height: 200 !important;
        }

        .float {
            position: fixed;
            bottom: 140px;
            right: 140px;
        }

        /* following 3 to centralize page */
        #inner-div {
            margin-left: auto;
            margin-right: auto;
            width: 600px
        }

        #middle-div {
            display: table-cell;
            vertical-align: middle
        }

        #outer-div {
            display: table;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <link rel="icon" href="/favicon-7280cc0f5f8a17b.svg">
    <script>function read_file_content() {
    const fileSelector = document.getElementById("file-selector")
    progress_div = document.getElementById("progress")
    progress_div.innerText = "Processing..."


    const reader = new FileReader();
    reader.addEventListener('load', (ev) => {
        buffer = ev.target.result
        int_array = Array.from(new Uint8Array(buffer))
        file_name = fileSelector.files[0].name
        window.qrtransfer.send(file_name, int_array)
        document.getElementById("scroll-check-div").style.display = "block";
    });
    reader.readAsArrayBuffer(fileSelector.files[0])
}

function scroll() {
    window.scrollBy({
        top: 200,
        behavior: 'instant'
    });
}

function start_scroll() {
    window.scrollIntervalId = setInterval(
        scroll,
        1000
    );
    console.log("start_scroll");
}

function stop_scroll() {
    clearInterval(window.scrollIntervalId);
    console.log("stop_scroll");
}

function toggle_scroll() {
    if (document.getElementById("scroll-check").checked) {
        start_scroll();
    } else {
        stop_scroll();
    }
}
</script>
    <script>let context = new AudioContext();
const beep = (freq = 1500, duration = 30, vol = 100) => {
    const oscillator = context.createOscillator();
    const gain = context.createGain();
    oscillator.connect(gain);
    oscillator.frequency.value = freq;
    oscillator.type = "square";
    gain.connect(context.destination);
    gain.gain.value = vol * 0.01;
    oscillator.start(context.currentTime);
    oscillator.stop(context.currentTime + duration * 0.001);
}

async function beepN(n) {
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    for (let i = 0; i < n; i++) {
        beep();
        await sleep(50);
    }
}

function add_download(base64_data, file_name) {
    let a = document.createElement("a");
    a.href = "data:;base64," + base64_data;
    a.download = file_name;
    a.innerText = "Download";
    document.getElementById("receive").appendChild(a);
    a.click();
}

function start_receiving() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(
        function (stream) {
            var video = document.getElementById('scan-video');
            var canvas = document.getElementById('canvas');
            var camQrResult = document.getElementById('cam-qr-result');
            var ctx = canvas.getContext('2d');
            var decoder = window.qrtransfer.new_decoder();
            window.decoder = decoder;

            video.srcObject = window.stream = stream;
            video.onloadedmetadata = () => {
                window.intervalId = setInterval(() => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    var myImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    let counter = decoder.scan(
                        canvas.width, canvas.height, Array.from(myImageData.data)
                    );
                    if (counter > 0) {
                        camQrResult.textContent = window.decoder.get_progress();
                        beepN(counter);
                        if (decoder.is_finished()) {
                            stop_receiving();
                            var finished = window.decoder.get_finished();
                            add_download(finished.to_base64(), finished.get_name());
                        }
                    }
                }, 40);
            };
        }
    )
}

function stop_receiving() {
    window.stream.getTracks().forEach(function (track) {
        track.stop();
    });
    clearInterval(window.intervalId);
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

</script>
    <script type="module">import init from '/qrtransfer-c8eb68a02b993a65.js';init('/qrtransfer-c8eb68a02b993a65_bg.wasm');</script>
    <!-- <script src="//cdn.bootcdn.net/ajax/libs/eruda/2.3.3/eruda.js"></script>
    <script>eruda.init();</script> -->

<link rel="preload" href="/qrtransfer-c8eb68a02b993a65_bg.wasm" as="fetch" type="application/wasm" crossorigin="">
<link rel="modulepreload" href="/qrtransfer-c8eb68a02b993a65.js"></head>


<body>
    <div id="outer-div">

        <div id="scroll-check-div" class="form-check form-switch float" style="display: none;">
            <input class="form-check-input" type="checkbox" id="scroll-check" onclick="toggle_scroll()">
            <label class="form-check-label" for="scroll-check">Scroll</label>
        </div>

        <div id="middle-div">
            <div id="inner-div">
                <div id="main-page" style="display: none;">
                    <h1>qrtransfer</h1>
                    <!-- Nav tabs -->
                    <ul class=" nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="send-tab" data-bs-toggle="tab" data-bs-target="#send" type="button" role="tab" aria-controls="send" aria-selected="true">Send</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="receive-tab" data-bs-toggle="tab" data-bs-target="#receive" type="button" role="tab" aria-controls="receive" aria-selected="false">Receive</button>
                        </li>
                    </ul>
                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div class="tab-pane active" id="send" role="tabpanel" aria-labelledby="send-tab">
                            <input type="file" id="file-selector" class="form-control form-control-lg" onchange="read_file_content()">
                            <!-- <input type="file" id="file-selector" data-mdb-file-upload="file-upload" onchange="read_file_content()"> -->
                            <div id="progress"></div>
                            <div id="qrcode"></div>
                        </div>
                        <div class="tab-pane" id="receive" role="tabpanel" aria-labelledby="receiv-tab">
                            <video id="scan-video" playsinline="" autoplay=""></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                            <div id="cam-qr-result" style="white-space: pre;word-wrap:break-word;"></div>
                            <br>
                            <button id="start-button" class="btn btn-outline-primary" onclick="start_receiving()">Start</button>
                            <button id="stop-button" class="btn btn-outline-danger" onclick="stop_receiving()">Stop</button>
                        </div>
                    </div>
                </div>

                <div id="spinner">
                    <div class="d-flex align-items-center">
                        <strong>Loading...</strong>
                        <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous">
    </script>


</body></html>