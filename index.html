<!-- <!doctype html> --><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>qrtransfer</title>
    <style>
        svg {
            width: 200 !important;
            height: 200 !important;
        }

        .float {
            position: fixed;
            bottom: 140px;
            right: 140px;
        }

        /* following 3 to centralize page */
        #inner-div {
            margin-left: auto;
            margin-right: auto;
            width: 600px
        }

        #middle-div {
            display: table-cell;
            vertical-align: middle
        }

        #outer-div {
            display: table;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <link rel="icon" href="/favicon-7280cc0f5f8a17b.svg">
    <script>let context = new AudioContext();
const beep = (freq = 1500, duration = 30, vol = 100) => {
    const oscillator = context.createOscillator();
    const gain = context.createGain();
    oscillator.connect(gain);
    oscillator.frequency.value = freq;
    oscillator.type = "square";
    gain.connect(context.destination);
    gain.gain.value = vol * 0.01;
    oscillator.start(context.currentTime);
    oscillator.stop(context.currentTime + duration * 0.001);
}

async function beepN(n) {
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    for (let i = 0; i < n; i++) {
        beep();
        await sleep(50);
    }
}

function add_download(base64_data, file_name) {
    let a = document.createElement("a");
    a.href = "data:;base64," + base64_data;
    a.download = file_name;
    a.innerText = "Download";
    document.getElementById("receive").appendChild(a);
    a.click();
}

function start_receiving() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(
        function (stream) {
            var video = document.getElementById('scan-video');
            var canvas = document.getElementById('canvas');
            var camQrResult = document.getElementById('cam-qr-result');
            var ctx = canvas.getContext('2d');
            var decoder = window.qrtransfer.new_decoder();
            window.decoder = decoder;

            video.srcObject = window.stream = stream;
            video.onloadedmetadata = () => {
                window.intervalId = setInterval(() => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    var myImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    let counter = decoder.scan(
                        canvas.width, canvas.height, Array.from(myImageData.data)
                    );
                    if (counter > 0) {
                        camQrResult.textContent = window.decoder.get_progress();
                        beepN(counter);
                        if (decoder.is_finished()) {
                            stop_receiving();
                            var finished = window.decoder.get_finished();
                            add_download(finished.to_base64(), finished.get_name());
                        }
                    }
                }, 40);
            };
        }
    )
}

function stop_receiving() {
    window.stream.getTracks().forEach(function (track) {
        track.stop();
    });
    clearInterval(window.intervalId);
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

</script>
    <!-- <script src="//cdn.bootcdn.net/ajax/libs/eruda/2.3.3/eruda.js"></script>
    <script>eruda.init();</script> -->
<script>console.log("Initializing wasm...");</script>
<link rel="preload" href="/qrtransfer-e8505a26bf429cea_bg.wasm" as="fetch" type="application/wasm" crossorigin="">
<link rel="modulepreload" href="/qrtransfer-e8505a26bf429cea.js"></head>



<body>
    <div id="main"> </div>
    <div id="spinner">
        <div class="d-flex align-items-center">
            <strong>Loading...</strong>
            <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous">
    </script>


<script type="module">import init from '/qrtransfer-e8505a26bf429cea.js';init('/qrtransfer-e8505a26bf429cea_bg.wasm');</script></body></html>