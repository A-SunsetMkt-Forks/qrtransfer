<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <style>
        svg {
            width: 200 !important;
            height: 200 !important;
        }
    </style>
    <script src="//cdn.bootcdn.net/ajax/libs/eruda/2.3.3/eruda.js"></script>
    <script>eruda.init();</script>
</head>

<body>
    <h1>Send</h1>
    <script type="module">
        import init, { send, my_set_panic_hook, Decoder } from './pkg/qrtransfer.js';
        await init();
        my_set_panic_hook();
        window.send = send
        window.Decoder = Decoder
    </script>

    <input type="file" id="file-selector">
    <script>
        const fileSelector = document.getElementById("file-selector")
        function read_file_content(ev) {
            progress_div = document.getElementById("progress")
            progress_div.innerText = "Processing..."


            const reader = new FileReader();
            reader.addEventListener('load', (ev) => {
                buffer = event.target.result
                int_array = Array.from(new Uint8Array(buffer))
                file_name = fileSelector.files[0].name
                window.send(file_name, int_array)
                progress_div.innerText = "Finished."
            });
            reader.readAsArrayBuffer(fileSelector.files[0])
        }

        document.getElementById("file-selector").addEventListener("change", read_file_content)
    </script>
    <div id="progress"></div>
    <div id="qrcode"></div>

    <br style="clear:both;">
    <hr>
    <h1>Receive</h1>

    <script>
        let context = new AudioContext();
        const beep = (freq = 1500, duration = 30, vol = 100) => {
            const oscillator = context.createOscillator();
            const gain = context.createGain();
            oscillator.connect(gain);
            oscillator.frequency.value = freq;
            oscillator.type = "square";
            gain.connect(context.destination);
            gain.gain.value = vol * 0.01;
            oscillator.start(context.currentTime);
            oscillator.stop(context.currentTime + duration * 0.001);
        }
    </script>


    <video id='scan-video' playsinline autoplay></video>
    <canvas id='canvas'></canvas>
    <span id="cam-qr-result" style="white-space: pre;word-wrap:break-word;"></span>
    <br>
    <button id="start-button" onclick="start_receiving()">Start</button>
    <button id="stop-button" onclick="stop_receiving()">Stop</button>
    <script>
        function add_download(base64_data) {
            let a = document.createElement("a");
            a.href = "data:;base64," + base64_data;
            a.download = window.decoder.get_name();
            a.innerText = "Download";
            document.body.appendChild(a);
            a.click();
        }

    </script>


    <script>
        function start_receiving() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(
                function (stream) {
                    var video = document.getElementById('scan-video');
                    var canvas = document.getElementById('canvas');
                    var camQrResult = document.getElementById('cam-qr-result');
                    var ctx = canvas.getContext('2d');
                    var decoder = window.Decoder.new();
                    window.decoder = decoder;

                    video.srcObject = window.stream = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        window.intervalId = setInterval(() => {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            ctx.drawImage(video, 0, 0);
                            var myImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            let counter = decoder.scan(
                                canvas.width, canvas.height, Array.from(myImageData.data)
                            );
                            if (counter > 0) {
                                camQrResult.textContent = window.decoder.get_progress();
                                for (let i = 0; i < counter; i++) {
                                    beep();
                                }
                                if (decoder.is_finished()) {
                                    stop_receiving();
                                    add_download(window.decoder.to_base64());
                                }
                            }
                        }, 40);
                    };
                }
            )
        }

        function stop_receiving() {
            window.stream.getTracks().forEach(function (track) {
                track.stop();
            });
            clearInterval(window.intervalId);
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }


    </script>
</body>

</html>